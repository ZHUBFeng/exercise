<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Hello World</title>
  <script src="./js/react.development.js"></script>
  <script src="./js/react-dom.development.js"></script>
  <script src="./js/immer.umd.js"></script>

  <!-- Don't use this in production: -->
  <script src="./js/babel.min.js"></script>
  <link rel="stylesheet" href="./base2.css">
</head>

<body>
  <div id="root"></div>
  <script>
    class Minesweeper {
      constructor(width = 10, height = 8, mine = 10) {
        this.width = width
        this.height = height

        this.board = new Array(height).fill(0).map(row => new Array(width).fill('E'))

        this.mineCount = mine

        this.trueFlagCount = 0

        this.generateMine(this.mineCount)
      }

      generateMine(mine) {
        var i = 0
        while (true) {
          var x = Math.floor(Math.random() * this.height)
          var y = Math.floor(Math.random() * this.width)
          if (this.board[x][y] == 'E') {
            this.board[x][y] = 'M'
            i++
            if (i == mine) {
              break
            }
          } else {
            continue
          }
        }
      }

      updateBoard(x, y) {
        if (this.board[x][y] == 'M') {
          this.board[x][y] = 'X'
          return
        }

        var mineCount = 0
        //计算周围的雷数
        for (var i = x - 1; i <= x + 1; i++) {
          for (var j = y - 1; j <= y + 1; j++) {
            if (this.board[i] && (this.board[i][j] == 'M' || this.board[i][j] == 'MM')) {
              mineCount++
            }
          }
        }
        if (mineCount) {
          this.board[x][y] = mineCount
        }

        if (/\d+/.test(this.board[x][y])) {
          return
        }

        for (var m = x - 1; m <= x + 1; m++) {
          for (var n = y - 1; n <= y + 1; n++) {
            if (this.board[m] && this.board[m][n] == 'E') {
              this.board[m][n] = 'B'
              this.updateBoard(m, n)
            } else if (/\d+/.test(this.board[x][y])) {
              continue
            }
          }
        }
      }

      toString() {
        return '\n' + this.board.map(it => it.join('  ')).join('\n')
      }
    }

    const produce = immer.produce
    const useState = React.useState
    const useEffect = React.useEffect
  </script>

  <script type="text/babel">
    function App() {
      var [m, setM] = useState(new Minesweeper())
      var [trueFlagCount, setTrueFlagCount] = useState(0)
      var [level, setLevel] = useState('easy')
      var [mineCount, setMineCount] = useState(m.mineCount)
      var [lose, setLose] = useState(false)
      var [over, setOver] = useState(false)
      var [firstClick, setFirst] = useState(true)
      var [invalidFlag, setInvalidFlag] = useState([])
      var [timer, setTimer] = useState('000')

      var interval

      var srcAry = [
        'clock_icon.png', 'flag_icon.png', 'flag_plant.png', 'incorrect_flag.png', 'lose_screen.png',
        'refresh_white_24dp.png', 'trophy_icon.png', 'win_screen.png', '地雷.png'
      ]
      

      useEffect(() => {
        async function loadImg(srcAry) {
          await Promise.all(srcAry.map(img => load('./imgs/' + img)))

          function load(src) {
            return new Promise(resolve => {
              var img = new Image()
              img.src = src
              img.onload = resolve
            })
          }
        }

        loadImg(srcAry)
      }, [srcAry])

      useEffect(() => {
        setMineCount(m.mineCount)
        setLose(false)
      }, [level])

      function changeLevel(e) {
        var newLevel = e.target.value 
        if(newLevel === 'easy') {
          var newMinesweeper = new Minesweeper()
        } else if(newLevel === 'medium') {
          var newMinesweeper = new Minesweeper(18, 14, 40)
        } else {
          var newMinesweeper = new Minesweeper(24, 20, 99)
        }

        setLevel(newLevel)
        setM(newMinesweeper)
        setTrueFlagCount(0)
      }

      function setTime() {
        let time = 0
        
        interval = setInterval(() => {
          setTimer((++time).toString().padStart(3, 0))
          
          if (time == 999) {
            clearInterval(interval)
          }
        }, 1000);
      }

      function test(cx, cy) {
        var width = m.width
        var height = m.height
        var leftMineCount = 0

        var turnCount = 0
        
        for(var i = 0; i < height; i++) {
          //有未翻开或标记错的直接返回
          var unknowCount = m.board[i].filter(it => it === 'E' || it === 'EM')

          if(unknowCount.length > 0) {
            return false
          }

          turnCount += m.board[i].filter(it => it.length !== 2 && it !== 'M').length
          leftMineCount += m.board[i].filter(it => it === 'M').length

          if(i === height - 1 && trueFlagCount + leftMineCount + turnCount === width * height) {
            return true
          }
        }

      }

      function leftHandler(pos) {
        if (!lose) {
          if (firstClick) {
            setTime()
            setFirst(false)

            if (invalidFlag.length > 0) {

              setM(produce(m => {
                invalidFlag.forEach(pos => {
                  var [x, y] = pos
                  m.board[x][y] = m.board[x][y].slice(0, 1)
                })
              }))

              setInvalidFlag([])
              setTrueFlagCount(0)
              setMineCount(m.mineCount)
            }
          }

          var [cx, cy] = [...pos]
          if (m.board[cx][cy].length == 2) {
            return
          } else {
            
            m.updateBoard(cx, cy)

            if (m.board[cx][cy] == 'X') {
              setLose(true)
              // gameOver(false, [cx, cy])
            }
          }

          if (test(cx, cy)) {
            // gameOver(true, [cx, cy])
          }
        }
      }

      function rightHandler(pos, e) {
        console.log(e,'e')
        if (!lose) {
          e.preventDefault()

          if (e.target.className !== 'turn' && e.target.className !== 'mCount') {
            var [cx, cy] = [...pos]
            
            if (firstClick) {
              setInvalidFlag(produce(it => {
                it.push([cx, cy])
              }))
            }

            if(m.board[cx][cy].length === 2) {
              if(m.board[cx][cy][0] === 'M') {
                setTrueFlagCount(trueFlagCount-1)
              }
              setM(produce(m => {
                m.board[cx][cy] = m.board[cx][cy].slice(0, 1)
              }))
              setMineCount(mineCount + 1)
            }else if(m.board[cx][cy].length === 1) {
              setM(produce(m => {
                m.board[cx][cy] += 'M'
              }))
              if(m.board[cx][cy][0] === 'M') {
                setTrueFlagCount(trueFlagCount + 1)
              }
              setMineCount(mineCount - 1)
            }

            if (test(cx, cy)) {
              console.log('win')
              // gameOver(true, [cx, cy])
            }
          }
        }
      }

      function middleHandler(pos) {
        var [cx, cy] = [...pos]

        if (e.button == 1 && typeof m.board[cx][cy] === 'number' && !lose) {
          
          //计算标记的雷数
          var count = 0
          var flag1 = false

          for (var s = cx - 1; s <= cx + 1; s++) {
            for (var v = cy - 1; v <= cy + 1; v++) {
              if (m.board[s] && m.board[s][v]) {

                if(m.board[s][v] === 'M') {
                  flag1 = true
                }

                if(m.board[s][v].length == 2) {
                  count++
                }

              }
            }
          }

          if (count == m.board[cx][cy]) {
            if(flag1) {
              setLose(true)
              // gameOver(false, [cx, cy])
              return
            }

            for (var i = cx - 1; i <= cx + 1; i++) {
              for (var j = cy - 1; j <= cy + 1; j++) {
                if (m.board[i]) {

                  if (m.board[i][j] == 'E') {
                    m.updateBoard(i, j)

                  } 
                  
                }
              }
            }


            if (test(cx, cy)) {
              // gameOver(true, [cx, cy])
            }

          }
        }
      

      }

      function addClass(item) {
        if(typeof item === 'number') {
          return 'mCount'
        }
        if(item === 'B') {
          return 'turn'
        }
        if(item === 'X') {
          return 'mine'
        }
        if(item === 'EM' || item === 'MM') {
          return 'mayMine'
        }
        return ''
      }

      return (
        <div id="main" className={level}>
          <div className="header">
            <select className="level" onChange={changeLevel}>
              <option value="easy">简单</option>
              <option value="medium">中等</option>
              <option value="hard">困难</option>
            </select>

            <div className="message">
              <i></i>
              <span className="leftMine">{ mineCount }</span>
              <i></i>
              <span className="time">{timer}</span>
            </div>
            
          </div>  
          
          <div id="board">
            {
              m.board.map((row, idx) => {
                return (
                  <div className="row" key={idx}>
                    {
                      row.map((item, idy) => {
                        return (
                          <span key={idy} 
                            onClick={() => leftHandler([idx, idy])} 
                            onMouseDown={(e) => middleHandler([idx, idy], e)} 
                            onContextMenu={(e) => rightHandler([idx, idy], e)} 
                            className={addClass(item)}
                          >
                            {item > 0 ? item : ' '}
                          </span>
                        )
                      })
                    }  
                  </div>
                )
              })
            }   
          </div>

          
          {
            over && 
            <div class="win dialog">
              <div class="result">
                {
                  lose ? <img src="./imgs/clock_icon.png" alt=""/> : <img src="./imgs/trophy_icon.png" alt=""/>
                }
                <div class="finTime"></div>
              </div>
              <div class="btn">
                {
                  lose ?  <div><img src="./imgs/refresh_white_24dp.png" alt=""/><span>再试一次吧</span> </div>
                  : <div><img src="./imgs/refresh_white_24dp.png" alt=""/><span>再玩一次吧</span></div>
                }
              </div>
            </div>
          }


        </div>
      )
    }
    


    ReactDOM.render(
        <App />,
        document.getElementById('root')
      );

    </script>
  <!--
      Note: this page is a great way to try React but it's not suitable for production.
      It slowly compiles JSX with Babel in the browser and uses a large development build of React.

      Read this section for a production-ready setup with JSX:
      https://reactjs.org/docs/add-react-to-a-website.html#add-jsx-to-a-project

      In a larger project, you can use an integrated toolchain that includes JSX instead:
      https://reactjs.org/docs/create-a-new-react-app.html

      You can also use React without JSX, in which case you can remove Babel:
      https://reactjs.org/docs/react-without-jsx.html
    -->
</body>

</html>